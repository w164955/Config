let url=$request.url;let body=$request.body;let type=url.match(/aliyun|pikpak|quark/)[0];switch(type){case "aliyun":aliyun();break;case "pikpak":pikpak();break;case "quark":quark();break;default:$done({});}function aliyun(){let jsonTk=$persistentStore.read("ali_token")?.split(",")||[];let access_token="Bearer "+jsonTk[0];let refresh_token=jsonTk[1];let default_drive_id=jsonTk[2];let req={url:"https://api.aliyundrive.com/adrive/v3/file/list",headers:{Authorization:access_token,"Content-Type":"application/json",},};!(async()=>{switch(url.match(/(auth|entry)\.cgi$/)?.[0]){case "auth.cgi":let password=refresh_token||body.match(/passwd=([^&]*)/)[1];req.url="https://auth.aliyundrive.com/v2/account/token";req.body=`{"refresh_token":"${password}","grant_type":"refresh_token"}`;let json=await http(req,"post");let jstk=`${json.access_token},${json.refresh_token},${json.default_drive_id}`;$persistentStore.write(jstk,"ali_token");$done({response:{status:200,body:`{"success":true,"data":{"sid":"${json.access_token}"}}`,},});break;case "entry.cgi":if(body.match("Delete&")){let id=body.match(/path=([^&]+)/)[1];req.url="https://api.aliyundrive.com/v3/batch";req.body=`{"resource":"file","requests":[{"method":"POST","headers":{"Content-Type":"application\/json"},"id":"${id}","body":{"file_id":"${id}","drive_id":"${default_drive_id}"},"url":"\/recyclebin\/trash"}]}`;$done(req);}else if(body.match("method=get")){photo();}else{let parent_file_id="root";let path=body.match(/folder_path=([^&]+)/)?.[1];let a=path?((req.url=req.url.replace(/(parent_id=)/,`$1${path}`,)),(parent_file_id=path),"files"):"shares";let _body={fields:"*",drive_id:default_drive_id,order_direction:"DESC",order_by:"updated_at",limit:100,parent_file_id:parent_file_id,all:false,};req.body=JSON.stringify(_body);let shares=[];do{var{items,next_marker}=await http(req,"post");let data=items.map((item)=>{return{isdir:item.type==="folder",path:item.file_id,name:item.name,additional:{size:item.size,},};});shares=shares.concat(data);if(next_marker){_body.marker=next_marker;req.body=JSON.stringify(_body);}}while(next_marker);$done({response:{status:200,body:JSON.stringify({success:true,data:{total:0,offset:0,[a]:shares},}),},});}break;default:let fileid=url.match("fbdownload")?hex2str(url.match(/dlink=%22(.*)%22/)[1]):url.match(/path=(.*$)/)[1];req.url="https://api.aliyundrive.com/v2/file/get_download_url";req.body=`{"file_id":"${fileid}","expire_sec":14400,"drive_id":"${default_drive_id}"}`;$request.url=(await http(req,"post")).url.replace(/https/,"http",);$request.headers.Referer="https://www.aliyundrive.com/";delete $request.headers.Host;$done($request);}})().catch(()=>$done());}function pikpak(){let _url=["https://api-drive.mypikpak.com/drive/v1/files?filters=%7B%22phase%22%3A%7B%22eq%22%3A%22PHASE_TYPE_COMPLETE%22%7D%2C%22trashed%22%3A%7B%22eq%22%3Afalse%7D%7D","","&parent_id=","","&thumbnail_size=SIZE_LARGE",];let req={url:_url.join(""),headers:{authorization:$persistentStore.read("pikpak-ck")},};!(async()=>{switch(url.match(/(auth|entry)\.cgi$/)?.[0]){case "auth.cgi":body=decodeURIComponent(body);let username=body.match(/account=([^&]+)/)[1];let password=body.match(/passwd=([^&]+)/)[1];let token="Bearer "+(await http({url:"https://user.mypikpak.com/v1/auth/signin",body:`{"client_id":"YNxT9w7GMdWvEOKa","username":"${username}","password":"${password}"}`,},"post",))?.["access_token"];$persistentStore.write(token,`pikpak-ck`);$done({response:{status:200,body:`{"success":true,"data":{"sid":"${token}"}}`,},});break;case "entry.cgi":if(body.match("Delete&")){req.url="https://api-drive.mypikpak.com/drive/v1/files:batchTrash";req.body=`{"ids":["${body.match(/path=([^&]+)/)[1]}"]}`;$done(req);}else if(body.match("method=get")){photo();}else{let path=body.match(/folder_path=([^&]+)/)?.[1];let a=path?((_url[3]=path),"files"):"shares";let shares=[];do{req.url=_url.join("");var{files,next_page_token}=await http(req);let data=files.map((item)=>{return{isdir:!item.file_extension,path:item.id,name:item.name,additional:{size:parseInt(item.size)},};});if(next_page_token){_url[1]="&page_token="+next_page_token;}shares=shares.concat(data);}while(next_page_token);$done({response:{status:200,body:JSON.stringify({success:true,data:{total:0,offset:0,[a]:shares},}),},});}break;default:let fids=url.match("fbdownload")?hex2str(url.match(/dlink=%22(.*)%22/)[1]):url.match(/path=(.*$)/)[1];req.url=`https://api-drive.mypikpak.com/drive/v1/files/${fids}?&thumbnail_size=SIZE_LARGE`;link=(await http(req)).links["application/octet-stream"].url.replace(/https/,"http");$done({response:{status:302,headers:{Location:link},},});}})().catch(()=>$done());}function quark(){let ck=$persistentStore.read("quark-ck");let _url=["https://drive.quark.cn/1/clouddrive/file/sort?_fetch_total=1&_page=","1","&_size=100&fr=pc&pdir_fid=",0,"&pr=ucpro",];let req={url:_url.join(""),headers:{cookie:ck,"content-type":"application/json"},};!(async()=>{switch(url.match(/(auth|entry)\.cgi$/)?.[0]){case "auth.cgi":ck=decodeURIComponent(body.match(/passwd=([^&]+)/)[1]);$persistentStore.write(ck,"quark-ck");$done({response:{status:200,body:`{"success":true,"data":{"sid":"${ck}"}}`,},});break;case "entry.cgi":if(body.match("Delete&")){req.url="https://drive.quark.cn/1/clouddrive/file/delete?fr=pc&pr=ucpro";req.body=`{"action_type":1,"exclude_fids":[],"filelist":[body.match(/path=([^&]+)/)[1]}`;$done(req);}else if(body.match("method=get")){photo();}else{let path=body.match(/folder_path=([^&]+)/)?.[1];let a=path?((_url[3]=path),"files"):"shares";let shares=[];do{req.url=_url.join("");let obj=await http(req,"get",1,ck);var _total=parseInt(obj.metadata._total/100)+1;let items=obj.data.list;let data=items.map((item)=>{return{isdir:!item.file,path:item.fid,name:item.file_name,additional:{size:item.size},};});shares=shares.concat(data);}while(_url[1]<_total&&_url[1]++);$done({response:{status:200,body:JSON.stringify({success:true,data:{total:0,offset:0,[a]:shares},}),},});}break;default:let fids=url.match("fbdownload")?hex2str(url.match(/dlink=%22(.*)%22/)[1]):url.match(/path=(.*$)/)[1];req.url="http://drive.quark.cn/1/clouddrive/file/download?fr=pc&pr=ucpro";req.body=`{"fids":["${fids}"]}`;let link=(await http(req,"post")).data[0].download_url.replace(/https/,"http");$request.url=link;$request.headers.cookie=ck;delete $request.headers.Host;$done($request);}})().catch(()=>$done());}function photo(){$done({response:{method:"GET",status:301,headers:{Location:`http://${type}.example.com:5000/webapi/entry.cgi?api=SYNO.FileStation.Download&version=2&method=download&mode=open&path=${body.match(/path=([^&?]+)/)[1] }`,},},});}function hex2str(hex){var trimedStr=hex.trim();var rawStr=trimedStr.substr(0,2).toLowerCase()==="0x"?trimedStr.substr(2):trimedStr;var len=rawStr.length;if(len%2!==0){return "";}var curCharCode;var resultStr=[];for(var i=0;i<len;i=i+2){curCharCode=parseInt(rawStr.substr(i,2),16);resultStr.push(String.fromCharCode(curCharCode));}return resultStr.join("");}function http(req,method="get",set,ck){return new Promise((res,jct)=>{$httpClient[method](req,(err,resp,data)=>{set&&(set=resp.headers?.["Set-Cookie"]?.split(";")[0])&&$persistentStore.write(ck.replace(/[^;]+/,set),"quark-ck");resp?.status===200?res(JSON.parse(data)):jct();});});}